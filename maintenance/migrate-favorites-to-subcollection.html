<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¦ê²¨ì°¾ê¸° ë§ˆì´ê·¸ë ˆì´ì…˜</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .info {
            background: #cfe2ff;
            border: 2px solid #0d6efd;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .success {
            background: #d1e7dd;
            border: 2px solid #198754;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .error {
            background: #f8d7da;
            border: 2px solid #dc3545;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .danger {
            background: #dc3545;
        }
        .danger:hover {
            background: #c82333;
        }
        #progress {
            margin: 20px 0;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        #log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.6;
            display: none;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
        }
        .log-info { color: #0d6efd; }
        .log-success { color: #198754; font-weight: bold; }
        .log-error { color: #dc3545; font-weight: bold; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #4CAF50;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ ì¦ê²¨ì°¾ê¸° ìƒí’ˆ ë§ˆì´ê·¸ë ˆì´ì…˜</h1>

        <div class="info">
            <strong>â„¹ï¸ ë§ˆì´ê·¸ë ˆì´ì…˜ ì •ë³´</strong>
            <p>ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ê³ ê°ì‚¬ ë¬¸ì„œì˜ favoriteProducts ë°°ì—´ì„ ì„œë¸Œì»¬ë ‰ì…˜ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
            <ul>
                <li><strong>ì›ë³¸</strong>: customers/{customerId}.favoriteProducts[]</li>
                <li><strong>ëŒ€ìƒ</strong>: customers/{customerId}/favoriteProducts/{productId}</li>
            </ul>
        </div>

        <div class="warning">
            <strong>âš ï¸ ì£¼ì˜ì‚¬í•­</strong>
            <ol>
                <li>ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ì— ë°˜ë“œì‹œ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…ì„ ìˆ˜í–‰í•˜ì„¸ìš”.</li>
                <li>ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘ì—ëŠ” ì‹œìŠ¤í…œ ì‚¬ìš©ì„ ì¤‘ë‹¨í•˜ì„¸ìš”.</li>
                <li>ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ í›„ ì›ë³¸ ë°ì´í„°ëŠ” ìë™ìœ¼ë¡œ ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
                <li>ê²€ì¦ ì™„ë£Œ í›„ "ì›ë³¸ ë°ì´í„° ì‚­ì œ" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì •ë¦¬í•˜ì„¸ìš”.</li>
            </ol>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalCustomers">0</div>
                <div class="stat-label">ì´ ê³ ê°ì‚¬</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="withFavorites">0</div>
                <div class="stat-label">ì¦ê²¨ì°¾ê¸° ìˆëŠ” ê³ ê°ì‚¬</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalFavorites">0</div>
                <div class="stat-label">ì´ ì¦ê²¨ì°¾ê¸° ìˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="migrated">0</div>
                <div class="stat-label">ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ</div>
            </div>
        </div>

        <div>
            <button onclick="analyzeData()" id="analyzeBtn">1ï¸âƒ£ ë°ì´í„° ë¶„ì„</button>
            <button onclick="startMigration()" id="migrateBtn" disabled>2ï¸âƒ£ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘</button>
            <button onclick="verifyMigration()" id="verifyBtn" disabled>3ï¸âƒ£ ê²€ì¦</button>
            <button onclick="cleanupOriginal()" id="cleanupBtn" disabled class="danger">4ï¸âƒ£ ì›ë³¸ ë°ì´í„° ì‚­ì œ</button>
        </div>

        <div id="progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
        </div>

        <div id="log"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import {
            getFirestore,
            collection,
            getDocs,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            deleteField,
            writeBatch,
            Timestamp
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase ì„¤ì • (admin .firebasercì—ì„œ ê°€ì ¸ì˜¨ ì„¤ì •)
        const firebaseConfig = {
            apiKey: "AIzaSyDf6RdPU7-lLXO_G8tBb-vGMo0RHnR0yts",
            authDomain: "jinhyun-wholesale.firebaseapp.com",
            projectId: "jinhyun-wholesale",
            storageBucket: "jinhyun-wholesale.firebasestorage.app",
            messagingSenderId: "767842862903",
            appId: "1:767842862903:web:a4b74d47b85f4b51b65f04",
            measurementId: "G-X5Q7WM2SV7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.migrationData = {
            customers: [],
            totalFavorites: 0,
            migratedCount: 0
        };

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            logEl.style.display = 'block';
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        function updateProgress(current, total) {
            const percent = Math.round((current / total) * 100);
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressFill').textContent = percent + '%';
        }

        window.analyzeData = async function() {
            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true;
            log('ë°ì´í„° ë¶„ì„ ì‹œì‘...', 'info');

            try {
                const customersSnapshot = await getDocs(collection(db, 'customers'));
                let totalCustomers = 0;
                let withFavorites = 0;
                let totalFavorites = 0;
                const customersWithFavorites = [];

                customersSnapshot.forEach(doc => {
                    totalCustomers++;
                    const data = doc.data();

                    if (data.favoriteProducts && Array.isArray(data.favoriteProducts) && data.favoriteProducts.length > 0) {
                        withFavorites++;
                        totalFavorites += data.favoriteProducts.length;
                        customersWithFavorites.push({
                            id: doc.id,
                            data: data,
                            favorites: data.favoriteProducts
                        });
                        log(`${data.businessName}: ${data.favoriteProducts.length}ê°œ ì¦ê²¨ì°¾ê¸°`, 'info');
                    }
                });

                window.migrationData.customers = customersWithFavorites;
                window.migrationData.totalFavorites = totalFavorites;

                document.getElementById('totalCustomers').textContent = totalCustomers;
                document.getElementById('withFavorites').textContent = withFavorites;
                document.getElementById('totalFavorites').textContent = totalFavorites;

                log(`ë¶„ì„ ì™„ë£Œ: ê³ ê°ì‚¬ ${totalCustomers}ê°œ ì¤‘ ${withFavorites}ê°œê°€ ì¦ê²¨ì°¾ê¸° ë³´ìœ `, 'success');
                document.getElementById('migrateBtn').disabled = withFavorites === 0;
            } catch (error) {
                log(`ë¶„ì„ ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
            }
        };

        window.startMigration = async function() {
            if (!confirm('ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }

            const btn = document.getElementById('migrateBtn');
            btn.disabled = true;
            document.getElementById('progress').style.display = 'block';
            log('ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘...', 'info');

            try {
                const { customers, totalFavorites } = window.migrationData;
                let migratedCount = 0;

                for (let i = 0; i < customers.length; i++) {
                    const customer = customers[i];
                    log(`[${i + 1}/${customers.length}] ${customer.data.businessName} ì²˜ë¦¬ ì¤‘...`, 'info');

                    for (const favorite of customer.favorites) {
                        try {
                            const favoriteData = {
                                productId: favorite.productId,
                                productName: favorite.productName,
                                productImage: favorite.productImage || null,
                                specification: favorite.specification || null,
                                displayOrder: favorite.displayOrder || 1,
                                isActive: favorite.isActive !== undefined ? favorite.isActive : true,
                                addedAt: Timestamp.now(),
                                updatedAt: Timestamp.now(),
                                addedBy: 'migration'
                            };

                            await setDoc(
                                doc(db, `customers/${customer.id}/favoriteProducts/${favorite.productId}`),
                                favoriteData
                            );

                            migratedCount++;
                            updateProgress(migratedCount, totalFavorites);
                        } catch (error) {
                            log(`  âŒ ${favorite.productName} ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨: ${error.message}`, 'error');
                        }
                    }

                    log(`  âœ… ${customer.data.businessName} ì™„ë£Œ (${customer.favorites.length}ê°œ)`, 'success');
                }

                window.migrationData.migratedCount = migratedCount;
                document.getElementById('migrated').textContent = migratedCount;

                log(`ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ: ${migratedCount}/${totalFavorites}ê°œ ì„±ê³µ`, 'success');
                document.getElementById('verifyBtn').disabled = false;
            } catch (error) {
                log(`ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
            }
        };

        window.verifyMigration = async function() {
            const btn = document.getElementById('verifyBtn');
            btn.disabled = true;
            log('ê²€ì¦ ì‹œì‘...', 'info');

            try {
                const { customers } = window.migrationData;
                let verified = 0;
                let errors = 0;

                for (const customer of customers) {
                    const subcollectionSnapshot = await getDocs(
                        collection(db, `customers/${customer.id}/favoriteProducts`)
                    );

                    if (subcollectionSnapshot.size !== customer.favorites.length) {
                        log(`  âš ï¸ ${customer.data.businessName}: ê°œìˆ˜ ë¶ˆì¼ì¹˜ (ì›ë³¸: ${customer.favorites.length}, ë§ˆì´ê·¸ë ˆì´ì…˜: ${subcollectionSnapshot.size})`, 'error');
                        errors++;
                    } else {
                        log(`  âœ… ${customer.data.businessName}: ê²€ì¦ ì„±ê³µ`, 'success');
                        verified++;
                    }
                }

                if (errors === 0) {
                    log(`ê²€ì¦ ì™„ë£Œ: ëª¨ë“  ë°ì´í„°ê°€ ì •ìƒì ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                    document.getElementById('cleanupBtn').disabled = false;
                } else {
                    log(`ê²€ì¦ ì™„ë£Œ: ${errors}ê°œ ê³ ê°ì‚¬ì—ì„œ ì˜¤ë¥˜ ë°œê²¬`, 'error');
                }
            } catch (error) {
                log(`ê²€ì¦ ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
            }
        };

        window.cleanupOriginal = async function() {
            if (!confirm('ì›ë³¸ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê²€ì¦ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.\nì´ ì‘ì—…ì€ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) {
                return;
            }

            if (!confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në§ˆì§€ë§‰ í™•ì¸ì…ë‹ˆë‹¤!')) {
                return;
            }

            const btn = document.getElementById('cleanupBtn');
            btn.disabled = true;
            log('ì›ë³¸ ë°ì´í„° ì‚­ì œ ì‹œì‘...', 'info');

            try {
                const { customers } = window.migrationData;

                for (const customer of customers) {
                    await updateDoc(doc(db, 'customers', customer.id), {
                        favoriteProducts: deleteField()
                    });
                    log(`  âœ… ${customer.data.businessName}: favoriteProducts í•„ë“œ ì‚­ì œ`, 'success');
                }

                log('ì›ë³¸ ë°ì´í„° ì‚­ì œ ì™„ë£Œ!', 'success');
            } catch (error) {
                log(`ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
            }
        };

        window.log = log;
    </script>
</body>
</html>
