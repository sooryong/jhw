rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function: Get user role by authUid (requires query)
    function getUserRole(authUid) {
      return get(/databases/$(database)/documents/users/$(authUid)).data.role;
    }

    match /users/{userId} {
      // 사용자 문서 ID는 이제 uid로 변경됨 (마이그레이션 후)
      // 자기 자신의 문서 읽기 가능
      allow read: if request.auth != null && request.auth.uid == userId;

      // 자기 자신의 문서 일부 필드 수정 가능 (알림 설정 등)
      allow update: if request.auth != null && request.auth.uid == userId &&
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['uid', 'role', 'linkedCustomers', 'isActive']));

      // admin/staff는 모든 사용자 읽기 가능
      allow read: if request.auth != null;

      // admin/staff는 다른 사용자의 문서 업데이트 가능 (linkedCustomers 포함)
      allow update: if request.auth != null;

      // admin만 사용자 생성/삭제 가능 (Cloud Functions에서 처리)
      allow create: if request.auth != null;
      allow delete: if false; // 삭제는 Cloud Function에서만 가능
    }

    match /referenceData/{document} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // 고객사 관리 (customers 컬렉션)
    match /customers/{businessNumber} {
      // 인증된 모든 사용자에게 읽기 허용 (애플리케이션 레벨에서 권한 제어)
      allow read: if request.auth != null;

      // 쓰기는 인증된 사용자만 가능 (애플리케이션 레벨에서 admin/staff 제어)
      allow write: if request.auth != null;
    }

    // 공급사 관리 (suppliers 컬렉션)
    match /suppliers/{businessNumber} {
      allow read, write: if request.auth != null;
    }

    // 상품 관리 (products 컬렉션)
    match /products/{productId} {
      allow read, write: if request.auth != null;
    }

    // 상품 코드 카운터 (productCounters 컬렉션)
    match /productCounters/{counterId} {
      allow read, write: if request.auth != null;
    }

    // SMS 수신자 관리 (smsRecipients 컬렉션)
    match /smsRecipients/{recipientId} {
      allow read, write: if request.auth != null;
    }

    // SMS 센터 수신자 관리 (smsCenterRecipients 컬렉션)
    match /smsCenterRecipients/{recipientId} {
      allow read, write: if request.auth != null;
    }

    // SMS 발송 이력 (smsHistory 컬렉션)
    match /smsHistory/{historyId} {
      allow read, write: if request.auth != null;
    }

    // 시스템 설정 (settings 컬렉션)
    match /settings/{settingId} {
      allow read, write: if request.auth != null;
    }

    // 매출주문 관리 (saleOrders 컬렉션)
    match /saleOrders/{orderId} {
      // admin/staff: 모든 주문 읽기/쓰기 가능
      allow read, write: if request.auth != null;

      // customer: 자신이 연결된 고객사의 주문만 읽기/생성 가능
      allow read: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        resource.data.customerId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.linkedCustomers;

      allow create: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        request.resource.data.customerId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.linkedCustomers;
    }

    // 매입주문 관리 (purchaseOrders 컬렉션)
    match /purchaseOrders/{orderId} {
      allow read, write: if request.auth != null;
    }

    // 확정 이력 관리 (confirmationHistory 컬렉션)
    match /confirmationHistory/{historyId} {
      allow read, write: if request.auth != null;
    }

    // 매입 원장 관리 (purchaseLedgers 컬렉션)
    match /purchaseLedgers/{ledgerId} {
      allow read, write: if request.auth != null;
    }

    // 매출 원장 관리 (saleLedgers 컬렉션)
    match /saleLedgers/{ledgerId} {
      allow read, write: if request.auth != null;
    }

    // 공급사 계정 관리 (supplierAccounts 컬렉션)
    match /supplierAccounts/{accountId} {
      allow read, write: if request.auth != null;
    }

    // 고객사 계정 관리 (customerAccounts 컬렉션)
    match /customerAccounts/{accountId} {
      allow read, write: if request.auth != null;
    }

    // 고객사 수금 관리 (customerPayments 컬렉션)
    match /customerPayments/{paymentId} {
      allow read, write: if request.auth != null;
    }

    // 공급사 지급 관리 (supplierPayments 컬렉션)
    match /supplierPayments/{paymentId} {
      allow read, write: if request.auth != null;
    }

    // [DEPRECATED] 일일확정 상태 관리 (dailyConfirmationStatus 컬렉션)
    // → dailyOrderCycles로 마이그레이션됨. 하위 호환성을 위해 유지
    match /dailyConfirmationStatus/{statusId} {
      allow read, write: if request.auth != null;
    }

    // 일일 주문 사이클 관리 (dailyOrderCycles 컬렉션)
    match /dailyOrderCycles/{cycleId} {
      allow read, write: if request.auth != null;
    }

    // 카운터 관리 (lastCounters 컬렉션) - 주문 ID 자동 생성용
    match /lastCounters/{counterId} {
      // 인증된 모든 사용자: 읽기/쓰기 허용 (주문 생성 시 필요)
      allow read, write: if request.auth != null;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}